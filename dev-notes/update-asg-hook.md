# Update ASG Hook

## Read commit history

Read the commit history to understand how we got here.

Working with commit 33404ee5486ff345ed738044aeb1cc3b71fdb129 (2023-09-01).

The doc says the hook is called `asg_scaling_processes`.

The Poetry project config says the hook is called `asg_scheduled_actions`.

The doc name is used in the code and is mentioned in the CHANGELOG.

```console
$ git ack -l -c asg_scaling_processes
CHANGELOG.md:1
docs/_source/apidoc/sceptre.hooks.rst:1
docs/_source/docs/hooks.rst:5
pyproject.toml:1
sceptre/hooks/asg_scaling_processes.py:4
tests/test_hooks/test_asg_scaling_processes.py:22
```q:q

The Poetry config name is mentioned in the CHANGELOG.

```console
$ git ack -l -c asg_scheduled_actions
CHANGELOG.md:1
pyproject.toml:1
```

Read the CHANGELOG. Each string appears once.

```markdown
## 1.3.0 (2017.10.16)

- Deprecating use of `asg_scheduled_actions` hook in favour of
  `asg_scaling_processes` hook.
```

Use this command to find commits that changed the number of occurrences of one of the hook names. Thanks to [Simon Willison](https://til.simonwillison.net/jq/git-log-json) for the recipe.

```bash
git log --reverse -S "(asg_scaling_processes|asg_scheduled_actions)" --pickaxe-regex --format="%cs%x00%h%x00%s" \
| jq -R -c 'split("\u0000") | {"commit date": .[0], "commit hash": .[1], "subject": .[2]}' \
| jtbl -m
```

<!-- vale off -->
| commit date | commit hash | subject                                                   |
|-------------|-------------|-----------------------------------------------------------|
| 2017-01-31  | 70dfb57     | Initial commit                                            |
| 2017-03-30  | d5008a4     | Add hook for ASG that supports all scaling processes      |
| 2017-03-31  | 9aa3b98     | Update docs, clean up docstrings                          |
| 2017-05-15  | 3ecf9cc     | Add rough website outline                                 |
| 2017-05-24  | 4e24b03     | Add sphinx docs to website                                |
| 2017-06-06  | 05c07fe     | Move hook and resolvers info to separate section          |
| 2017-06-09  | 7a366d1     | Add rough website outline                                 |
| 2017-06-09  | 79fa4a0     | Add sphinx docs to website                                |
| 2017-06-09  | 3ed4aa1     | Move hook and resolvers info to separate section          |
| 2017-07-12  | faa0e5d     | Remove autogenerated rst files                            |
| 2017-07-12  | 0fd489f     | Rename website to docs                                    |
| 2017-07-21  | 1e9dba5     | Remove old rst file                                       |
| 2017-10-11  | e52908b     | Deprecate asg-scheduled-actions hook (#216)               |
| 2017-10-16  | d300d20     | Update history                                            |
| 2017-11-29  | c995826     | Remove bash and asg scheduled actions hooks               |
| 2017-11-29  | c814e6a     | Remove bash and asg scheduled actions hooks               |
| 2017-11-29  | ec06452     | Entry point hooks (#205)                                  |
| 2017-11-29  | a48eb61     | [Resolves #5] Refactor Config class to ConfigReader class |
| 2018-11-19  | 182f0b6     | Implement algorithm to execute Stacks from StackGraph     |
| 2018-11-21  | 0ffb1a0     | Update project docs                                       |
| 2018-11-30  | 7e4aef5     | Update Hooks doc                                          |
| 2019-05-02  | 74f531e     | Improve documentation site (#655)                         |
| 2023-04-20  | ac9e439     | [Resolves #894] Switch to using poetry (#1323)            |
<!-- vale on -->

Read through these commits to see what happened.

```bash
git log --reverse -S "(asg_scaling_processes|asg_scheduled_actions)" --pickaxe-regex --format="%h" \
| xargs git show
```

The content shows in `less`. Use this command to search through the commit content: `/asg_|commit `. It stops at each hook and each commit header.

What follows is a summary of the matching commits.

* 70dfb57, the initial commit, already has the asg_scheduled_actions hook.
* d5008a4 adds the asg_scaling_processes hook.
* 9aa3b98 documents the asg_scaling_processes hook.
* 3ecf9cc documents both hooks in website/docs/stack_config.md. Today's asg_scaling_processes documentation looks like this.
* 4e24b03 uses the Sphinx automodule directive to generate pages from the hook source code.
* 3ed4aa1 moves the hook docs to website/docs/hooks.md.
* faa0e5d removes pages generated from source code.
* 0fd489f removes generated page docs/sceptre.hooks.rst, duplicate content in docs/stack_config.rst.
* 1e9dba5 removes more duplicate content.
* e52908b deprecates asg_scheduled_actions in favor of asg_scaling_processes.
* d300d20 documents deprecation as a feature of version 1.3.0.
* c995826 replaces asg_scheduled_actions with asg_scaling_processes in the hook docs examples and deletes the asg_scheduled_actions implementation and tests.
* ec06452 introduces a entry point concept called `sceptre.hooks` and requires that users create a Python package to add a hook. This is more complicated than it used to be, when it would just read hooks from the `project/hooks/myhook.py`. That's how I want it to work!
* ec06452 changes the entry_points setting in setup.py to add a mapping for the built-in hooks asg_scaling_processes and cmd. It maps the asg_scaling_processes hook to the deleted name asg_scheduled_actions!
* ec06452 in tests/test_config.py asserts that "!asg_scheduled_actions" is in ` yaml.SafeLoader.yaml_constructors`.
* a48eb61 refactors the asg_scaling_processes hook and deletes tests_test_config.py that asserted the YAML local tags.
* a48eb61 requires that each hook class require stack object reference for instantiation.
* 182f0b6 deletes a test that references asg_scaling_processes
* 0ffb1a0 reformats the changelog from reStructuredText (HISTORY.rst) to Markdown (CHANGELOG.md). It still contains the deprecation notice for version 1.3.0.
* 7e4aef5 reformats the hooks doc markup.
* 74f531e reintroduces a generated page from the asg_scaling_processes source code at docs/_source/apidoc/sceptre.hooks.rst. It reformats the hooks documentation from Markdown to reStructuredText.
* ac9e439 replaces setup.py with pyproject.toml. The replacement retains the name of the deleted hook as the entry point. in `tool.poetry.plugins."sceptre.hooks"`.

Of those matching commits, these commits explain the problem:

* e52908b deprecates asg_scheduled_actions in favor of asg_scaling_processes.
* d300d20 documents deprecation as a feature of version 1.3.0.
* c995826 replaces asg_scheduled_actions with asg_scaling_processes in the hook docs examples and deletes the asg_scheduled_actions implementation and tests.
* ec06452 changes the entry_points setting in setup.py to add a mapping for the built-in hooks asg_scaling_processes and cmd. It maps the asg_scaling_processes hook to the deleted name asg_scheduled_actions!
* ac9e439 replaces setup.py with pyproject.toml. The replacement retains the name of the deleted hook as the entry point. in `tool.poetry.plugins."sceptre.hooks"`.

Things I still don't know:

* How does Sceptre map the `!hook_name` in a stack config to a hook implementation? (Maybe has something to do with pyproject.toml, but how does it work at runtime?)
* Are there any tests that parse YAML files?
* How do I run the integration tests?

Proposal:

* Add another mapping to pyproject.toml to support the documented name.
* Deprecate the old name.
* Remove it in the next major version.
